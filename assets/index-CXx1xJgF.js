var nn=Object.defineProperty;var $t=e=>{throw TypeError(e)};var sn=(e,t,r)=>t in e?nn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var m=(e,t,r)=>sn(e,typeof t!="symbol"?t+"":t,r),Et=(e,t,r)=>t.has(e)||$t("Cannot "+r);var i=(e,t,r)=>(Et(e,t,"read from private field"),r?r.call(e):t.get(e)),v=(e,t,r)=>t.has(e)?$t("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),p=(e,t,r,s)=>(Et(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r),g=(e,t,r)=>(Et(e,t,"access private method"),r);var Wt=(e,t,r,s)=>({set _(a){p(e,t,a,r)},get _(){return i(e,t,s)}});var yr=cn,z=[],Ht="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var gt=0,an=Ht.length;gt<an;++gt)z[gt]=Ht[gt];function un(e){return z[e>>18&63]+z[e>>12&63]+z[e>>6&63]+z[e&63]}function on(e,t,r){for(var s,a=[],o=t;o<r;o+=3)s=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(e[o+2]&255),a.push(un(s));return a.join("")}function cn(e){for(var t,r=e.length,s=r%3,a=[],o=16383,c=0,d=r-s;c<d;c+=o)a.push(on(e,c,c+o>d?d:c+o));return s===1?(t=e[r-1],a.push(z[t>>2]+z[t<<4&63]+"==")):s===2&&(t=(e[r-2]<<8)+e[r-1],a.push(z[t>>10]+z[t>>4&63]+z[t<<2&63]+"=")),a.join("")}var H,Me=(H=class{constructor(t){m(this,"__time_duration_micros__");this.__time_duration_micros__=t}static getAlgebraicType(){return f.Product({elements:[{name:"__time_duration_micros__",algebraicType:f.I64}]})}static isTimeDuration(t){if(t.tag!=="Product")return!1;const r=t.value.elements;if(r.length!==1)return!1;const s=r[0];return s.name==="__time_duration_micros__"&&s.algebraicType.tag==="I64"}get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/H.MICROS_PER_MILLIS)}static fromMillis(t){return new H(BigInt(t)*H.MICROS_PER_MILLIS)}toString(){const t=this.micros,r=t<0?"-":"+",s=t<0?-t:t,a=s/1000000n,o=s%1000000n;return`${r}${a}.${String(o).padStart(6,"0")}`}},m(H,"MICROS_PER_MILLIS",1000n),H),O,it=(O=class{constructor(t){m(this,"__timestamp_micros_since_unix_epoch__");this.__timestamp_micros_since_unix_epoch__=t}get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}static getAlgebraicType(){return f.Product({elements:[{name:"__timestamp_micros_since_unix_epoch__",algebraicType:f.I64}]})}static isTimestamp(t){if(t.tag!=="Product")return!1;const r=t.value.elements;if(r.length!==1)return!1;const s=r[0];return s.name==="__timestamp_micros_since_unix_epoch__"&&s.algebraicType.tag==="I64"}static now(){return O.fromDate(new Date)}static fromDate(t){const r=t.getTime(),s=BigInt(r)*O.MICROS_PER_MILLIS;return new O(s)}toDate(){const r=this.__timestamp_micros_since_unix_epoch__/O.MICROS_PER_MILLIS;if(r>BigInt(Number.MAX_SAFE_INTEGER)||r<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(r))}since(t){return new Me(this.__timestamp_micros_since_unix_epoch__-t.__timestamp_micros_since_unix_epoch__)}},m(O,"MICROS_PER_MILLIS",1000n),m(O,"UNIX_EPOCH",new O(0n)),O),V,S,y,P,k,or,ue=(or=class{constructor(e){v(this,P);v(this,V);v(this,S);v(this,y,0);p(this,V,new Uint8Array(e)),p(this,S,new DataView(i(this,V).buffer))}toBase64(){return yr(i(this,V).subarray(0,i(this,y)))}getBuffer(){return i(this,V).slice(0,i(this,y))}get offset(){return i(this,y)}writeUInt8Array(e){const t=e.length;g(this,P,k).call(this,4+t),this.writeU32(t),i(this,V).set(e,i(this,y)),p(this,y,i(this,y)+e.length)}writeBool(e){g(this,P,k).call(this,1),i(this,S).setUint8(i(this,y),e?1:0),p(this,y,i(this,y)+1)}writeByte(e){g(this,P,k).call(this,1),i(this,S).setUint8(i(this,y),e),p(this,y,i(this,y)+1)}writeI8(e){g(this,P,k).call(this,1),i(this,S).setInt8(i(this,y),e),p(this,y,i(this,y)+1)}writeU8(e){g(this,P,k).call(this,1),i(this,S).setUint8(i(this,y),e),p(this,y,i(this,y)+1)}writeI16(e){g(this,P,k).call(this,2),i(this,S).setInt16(i(this,y),e,!0),p(this,y,i(this,y)+2)}writeU16(e){g(this,P,k).call(this,2),i(this,S).setUint16(i(this,y),e,!0),p(this,y,i(this,y)+2)}writeI32(e){g(this,P,k).call(this,4),i(this,S).setInt32(i(this,y),e,!0),p(this,y,i(this,y)+4)}writeU32(e){g(this,P,k).call(this,4),i(this,S).setUint32(i(this,y),e,!0),p(this,y,i(this,y)+4)}writeI64(e){g(this,P,k).call(this,8),i(this,S).setBigInt64(i(this,y),e,!0),p(this,y,i(this,y)+8)}writeU64(e){g(this,P,k).call(this,8),i(this,S).setBigUint64(i(this,y),e,!0),p(this,y,i(this,y)+8)}writeU128(e){g(this,P,k).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);i(this,S).setBigUint64(i(this,y),t,!0),i(this,S).setBigUint64(i(this,y)+8,r,!0),p(this,y,i(this,y)+16)}writeI128(e){g(this,P,k).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);i(this,S).setBigInt64(i(this,y),t,!0),i(this,S).setBigInt64(i(this,y)+8,r,!0),p(this,y,i(this,y)+16)}writeU256(e){g(this,P,k).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,s=e>>BigInt(64*1)&t,a=e>>BigInt(64*2)&t,o=e>>BigInt(64*3);i(this,S).setBigUint64(i(this,y)+8*0,r,!0),i(this,S).setBigUint64(i(this,y)+8*1,s,!0),i(this,S).setBigUint64(i(this,y)+8*2,a,!0),i(this,S).setBigUint64(i(this,y)+8*3,o,!0),p(this,y,i(this,y)+32)}writeI256(e){g(this,P,k).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,s=e>>BigInt(64*1)&t,a=e>>BigInt(64*2)&t,o=e>>BigInt(64*3);i(this,S).setBigUint64(i(this,y)+8*0,r,!0),i(this,S).setBigUint64(i(this,y)+8*1,s,!0),i(this,S).setBigUint64(i(this,y)+8*2,a,!0),i(this,S).setBigInt64(i(this,y)+8*3,o,!0),p(this,y,i(this,y)+32)}writeF32(e){g(this,P,k).call(this,4),i(this,S).setFloat32(i(this,y),e,!0),p(this,y,i(this,y)+4)}writeF64(e){g(this,P,k).call(this,8),i(this,S).setFloat64(i(this,y),e,!0),p(this,y,i(this,y)+8)}writeString(e){const r=new TextEncoder().encode(e);this.writeU32(r.length),g(this,P,k).call(this,r.length),i(this,V).set(r,i(this,y)),p(this,y,i(this,y)+r.length)}},V=new WeakMap,S=new WeakMap,y=new WeakMap,P=new WeakSet,k=function(e){const t=i(this,y)+e+1;if(t<=i(this,V).length)return;let r=i(this,V).length*2;r<t&&(r=t);const s=new Uint8Array(r);s.set(i(this,V)),p(this,V,s),p(this,S,new DataView(i(this,V).buffer))},or),x,w,Bt,gr,cr,te=(cr=class{constructor(e){v(this,Bt);v(this,x);v(this,w,0);p(this,x,new DataView(e.buffer,e.byteOffset,e.byteLength)),p(this,w,0)}get offset(){return i(this,w)}get remaining(){return i(this,x).byteLength-i(this,w)}readUInt8Array(){const e=this.readU32();return g(this,Bt,gr).call(this,e),this.readBytes(e)}readBool(){const e=i(this,x).getUint8(i(this,w));return p(this,w,i(this,w)+1),e!==0}readByte(){const e=i(this,x).getUint8(i(this,w));return p(this,w,i(this,w)+1),e}readBytes(e){const t=new Uint8Array(i(this,x).buffer,i(this,x).byteOffset+i(this,w),e);return p(this,w,i(this,w)+e),t}readI8(){const e=i(this,x).getInt8(i(this,w));return p(this,w,i(this,w)+1),e}readU8(){return this.readByte()}readI16(){const e=i(this,x).getInt16(i(this,w),!0);return p(this,w,i(this,w)+2),e}readU16(){const e=i(this,x).getUint16(i(this,w),!0);return p(this,w,i(this,w)+2),e}readI32(){const e=i(this,x).getInt32(i(this,w),!0);return p(this,w,i(this,w)+4),e}readU32(){const e=i(this,x).getUint32(i(this,w),!0);return p(this,w,i(this,w)+4),e}readI64(){const e=i(this,x).getBigInt64(i(this,w),!0);return p(this,w,i(this,w)+8),e}readU64(){const e=i(this,x).getBigUint64(i(this,w),!0);return p(this,w,i(this,w)+8),e}readU128(){const e=i(this,x).getBigUint64(i(this,w),!0),t=i(this,x).getBigUint64(i(this,w)+8,!0);return p(this,w,i(this,w)+16),(t<<BigInt(64))+e}readI128(){const e=i(this,x).getBigUint64(i(this,w),!0),t=i(this,x).getBigInt64(i(this,w)+8,!0);return p(this,w,i(this,w)+16),(t<<BigInt(64))+e}readU256(){const e=i(this,x).getBigUint64(i(this,w),!0),t=i(this,x).getBigUint64(i(this,w)+8,!0),r=i(this,x).getBigUint64(i(this,w)+16,!0),s=i(this,x).getBigUint64(i(this,w)+24,!0);return p(this,w,i(this,w)+32),(s<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readI256(){const e=i(this,x).getBigUint64(i(this,w),!0),t=i(this,x).getBigUint64(i(this,w)+8,!0),r=i(this,x).getBigUint64(i(this,w)+16,!0),s=i(this,x).getBigInt64(i(this,w)+24,!0);return p(this,w,i(this,w)+32),(s<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readF32(){const e=i(this,x).getFloat32(i(this,w),!0);return p(this,w,i(this,w)+4),e}readF64(){const e=i(this,x).getFloat64(i(this,w),!0);return p(this,w,i(this,w)+8),e}readString(){const e=this.readUInt8Array();return new TextDecoder("utf-8").decode(e)}},x=new WeakMap,w=new WeakMap,Bt=new WeakSet,gr=function(e){if(i(this,w)+e>i(this,x).byteLength)throw new RangeError(`Tried to read ${e} byte(s) at relative offset ${i(this,w)}, but only ${this.remaining} byte(s) remain`)},cr);function st(e){const t=e.replace(/([-_][a-z])/gi,r=>r.toUpperCase().replace("-","").replace("_",""));return t.charAt(0).toUpperCase()+t.slice(1)}function Qe(e,t){if(e===t)return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;const r=Object.keys(e),s=Object.keys(t);if(r.length!==s.length)return!1;for(const a of r)if(!s.includes(a)||!Qe(e[a],t[a]))return!1;return!0}function br(e){return Array.prototype.map.call(e.reverse(),t=>("00"+t.toString(16)).slice(-2)).join("")}function ln(e){if(e.length!=16)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new te(e).readU128()}function dn(e){if(e.length!=32)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new te(e).readU256()}function wr(e){e.startsWith("0x")&&(e=e.slice(2));const t=e.match(/.{1,2}/g)||[];return Uint8Array.from(t.map(s=>parseInt(s,16))).reverse()}function hn(e){return ln(wr(e))}function pn(e){return dn(wr(e))}function Ir(e){const t=new ue(16);return t.writeU128(e),t.getBuffer()}function mn(e){return br(Ir(e))}function vr(e){const t=new ue(32);return t.writeU256(e),t.getBuffer()}function fn(e){return br(vr(e))}function rt(e){return e.replace(/[-_]+/g,"_").replace(/_([a-zA-Z0-9])/g,(t,r)=>r.toUpperCase())}function nt(e,t){for(;t.tag==="Ref";)t=e.types[t.value];if(t.tag==="Product"){let s=0;for(const{algebraicType:a}of t.value.elements)s+=nt(e,a);return s}else if(t.tag==="Sum"){let s=1/0;for(const{algebraicType:a}of t.value.variants){const o=nt(e,a);o<s&&(s=o)}return s===1/0&&(s=0),4+s}else if(t.tag=="Array")return 4+4*nt(e,t.value);return{String:8,Sum:1,Bool:1,I8:1,U8:1,I16:2,U16:2,I32:4,U32:4,F32:4,I64:8,U64:8,F64:8,I128:16,U128:16,I256:32,U256:32}[t.tag]}var _r=class Rt{constructor(t){m(this,"__identity__");this.__identity__=typeof t=="string"?pn(t):t}static getAlgebraicType(){return f.Product({elements:[{name:"__identity__",algebraicType:f.U256}]})}isEqual(t){return this.toHexString()===t.toHexString()}equals(t){return this.isEqual(t)}toHexString(){return fn(this.__identity__)}toUint8Array(){return vr(this.__identity__)}static fromString(t){return new Rt(t)}static zero(){return new Rt(0n)}toString(){return this.toHexString()}},f={Ref:e=>({tag:"Ref",value:e}),Sum:e=>({tag:"Sum",value:e}),Product:e=>({tag:"Product",value:e}),Array:e=>({tag:"Array",value:e}),String:{tag:"String"},Bool:{tag:"Bool"},I8:{tag:"I8"},U8:{tag:"U8"},I16:{tag:"I16"},U16:{tag:"U16"},I32:{tag:"I32"},U32:{tag:"U32"},I64:{tag:"I64"},U64:{tag:"U64"},I128:{tag:"I128"},U128:{tag:"U128"},I256:{tag:"I256"},U256:{tag:"U256"},F32:{tag:"F32"},F64:{tag:"F64"},serializeValue(e,t,r,s){if(t.tag==="Ref"){if(!s)throw new Error("cannot serialize refs without a typespace");for(;t.tag==="Ref";)t=s.types[t.value]}switch(t.tag){case"Product":re.serializeValue(e,t.value,r,s);break;case"Sum":Qt.serializeValue(e,t.value,r,s);break;case"Array":if(t.value.tag==="U8")e.writeUInt8Array(r);else{const a=t.value;e.writeU32(r.length);for(const o of r)f.serializeValue(e,a,o,s)}break;case"Bool":e.writeBool(r);break;case"I8":e.writeI8(r);break;case"U8":e.writeU8(r);break;case"I16":e.writeI16(r);break;case"U16":e.writeU16(r);break;case"I32":e.writeI32(r);break;case"U32":e.writeU32(r);break;case"I64":e.writeI64(r);break;case"U64":e.writeU64(r);break;case"I128":e.writeI128(r);break;case"U128":e.writeU128(r);break;case"I256":e.writeI256(r);break;case"U256":e.writeU256(r);break;case"F32":e.writeF32(r);break;case"F64":e.writeF64(r);break;case"String":e.writeString(r);break}},deserializeValue:function(e,t,r){if(t.tag==="Ref"){if(!r)throw new Error("cannot deserialize refs without a typespace");for(;t.tag==="Ref";)t=r.types[t.value]}switch(t.tag){case"Product":return re.deserializeValue(e,t.value,r);case"Sum":return Qt.deserializeValue(e,t.value,r);case"Array":if(t.value.tag==="U8")return e.readUInt8Array();{const s=t.value,a=e.readU32(),o=[];for(let c=0;c<a;c++)o.push(f.deserializeValue(e,s,r));return o}case"Bool":return e.readBool();case"I8":return e.readI8();case"U8":return e.readU8();case"I16":return e.readI16();case"U16":return e.readU16();case"I32":return e.readI32();case"U32":return e.readU32();case"I64":return e.readI64();case"U64":return e.readU64();case"I128":return e.readI128();case"U128":return e.readU128();case"I256":return e.readI256();case"U256":return e.readU256();case"F32":return e.readF32();case"F64":return e.readF64();case"String":return e.readString()}},intoMapKey:function(e,t){switch(e.tag){case"U8":case"U16":case"U32":case"U64":case"U128":case"U256":case"I8":case"I16":case"I32":case"I64":case"I128":case"I256":case"F32":case"F64":case"String":case"Bool":return t;case"Product":return re.intoMapKey(e.value,t);default:{const r=new ue(10);return f.serializeValue(r,e,t),r.toBase64()}}}},re={serializeValue(e,t,r,s){for(const a of t.elements)f.serializeValue(e,a.algebraicType,r[a.name],s)},deserializeValue(e,t,r){const s={};if(t.elements.length===1){if(t.elements[0].name==="__time_duration_micros__")return new Me(e.readI64());if(t.elements[0].name==="__timestamp_micros_since_unix_epoch__")return new it(e.readI64());if(t.elements[0].name==="__identity__")return new _r(e.readU256());if(t.elements[0].name==="__connection_id__")return new vt(e.readU128())}for(const a of t.elements)s[a.name]=f.deserializeValue(e,a.algebraicType,r);return s},intoMapKey(e,t){if(e.elements.length===1){if(e.elements[0].name==="__time_duration_micros__")return t.__time_duration_micros__;if(e.elements[0].name==="__timestamp_micros_since_unix_epoch__")return t.__timestamp_micros_since_unix_epoch__;if(e.elements[0].name==="__identity__")return t.__identity__;if(e.elements[0].name==="__connection_id__")return t.__connection_id__}const r=new ue(10);return f.serializeValue(r,f.Product(e),t),r.toBase64()}},Qt={serializeValue:function(e,t,r,s){if(t.variants.length==2&&t.variants[0].name==="some"&&t.variants[1].name==="none")r!=null?(e.writeByte(0),f.serializeValue(e,t.variants[0].algebraicType,r,s)):e.writeByte(1);else{const a=r.tag,o=t.variants.findIndex(c=>c.name===a);if(o<0)throw`Can't serialize a sum type, couldn't find ${r.tag} tag ${JSON.stringify(r)} in variants ${JSON.stringify(t)}`;e.writeU8(o),f.serializeValue(e,t.variants[o].algebraicType,r.value,s)}},deserializeValue:function(e,t,r){const s=e.readU8();if(t.variants.length==2&&t.variants[0].name==="some"&&t.variants[1].name==="none"){if(s===0)return f.deserializeValue(e,t.variants[0].algebraicType,r);if(s===1)return;throw`Can't deserialize an option type, couldn't find ${s} tag`}else{const a=t.variants[s],o=f.deserializeValue(e,a.algebraicType,r);return{tag:a.name,value:o}}}},vt=class It{constructor(t){m(this,"__connection_id__");this.__connection_id__=t}static getAlgebraicType(){return f.Product({elements:[{name:"__connection_id__",algebraicType:f.U128}]})}isZero(){return this.__connection_id__===BigInt(0)}static nullIfZero(t){return t.isZero()?null:t}static random(){function t(){return Math.floor(Math.random()*255)}let r=BigInt(0);for(let s=0;s<16;s++)r=r<<BigInt(8)|BigInt(t());return new It(r)}isEqual(t){return this.__connection_id__==t.__connection_id__}equals(t){return this.isEqual(t)}toHexString(){return mn(this.__connection_id__)}toUint8Array(){return Ir(this.__connection_id__)}static fromString(t){return new It(hn(t))}static fromStringOrNull(t){const r=It.fromString(t);return r.isZero()?null:r}},yn={interval(e){return gn(e)},time(e){return bn(e)},getAlgebraicType(){return f.Sum({variants:[{name:"Interval",algebraicType:Me.getAlgebraicType()},{name:"Time",algebraicType:it.getAlgebraicType()}]})},isScheduleAt(e){if(e.tag!=="Sum")return!1;const t=e.value.variants;if(t.length!==2)return!1;const r=t.find(a=>a.name==="Interval"),s=t.find(a=>a.name==="Time");return!r||!s?!1:Me.isTimeDuration(r.algebraicType)&&it.isTimestamp(s.algebraicType)}},gn=e=>({tag:"Interval",value:new Me(e)}),bn=e=>({tag:"Time",value:new it(e)}),Br=yn,wn={getAlgebraicType(e){return f.Sum({variants:[{name:"some",algebraicType:e},{name:"none",algebraicType:f.Product({elements:[]})}]})}};function u(e,t){return{...e,...t}}var T=class{constructor(e){m(this,"type");m(this,"algebraicType");this.algebraicType=e}optional(){return new _t(this)}serialize(e,t){f.serializeValue(e,this.algebraicType,t)}deserialize(e){return f.deserializeValue(e,this.algebraicType)}},In=class extends T{constructor(){super(f.U8)}index(e="btree"){return new Ce(this,u(l,{indexType:e}))}unique(){return new Ce(this,u(l,{isUnique:!0}))}primaryKey(){return new Ce(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Ce(this,u(l,{isAutoIncrement:!0}))}default(e){return new Ce(this,u(l,{defaultValue:e}))}},vn=class extends T{constructor(){super(f.U16)}index(e="btree"){return new qe(this,u(l,{indexType:e}))}unique(){return new qe(this,u(l,{isUnique:!0}))}primaryKey(){return new qe(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new qe(this,u(l,{isAutoIncrement:!0}))}default(e){return new qe(this,u(l,{defaultValue:e}))}},_n=class extends T{constructor(){super(f.U32)}index(e="btree"){return new Pe(this,u(l,{indexType:e}))}unique(){return new Pe(this,u(l,{isUnique:!0}))}primaryKey(){return new Pe(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Pe(this,u(l,{isAutoIncrement:!0}))}default(e){return new Pe(this,u(l,{defaultValue:e}))}},Bn=class extends T{constructor(){super(f.U64)}index(e="btree"){return new ke(this,u(l,{indexType:e}))}unique(){return new ke(this,u(l,{isUnique:!0}))}primaryKey(){return new ke(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new ke(this,u(l,{isAutoIncrement:!0}))}default(e){return new ke(this,u(l,{defaultValue:e}))}},Un=class extends T{constructor(){super(f.U128)}index(e="btree"){return new Fe(this,u(l,{indexType:e}))}unique(){return new Fe(this,u(l,{isUnique:!0}))}primaryKey(){return new Fe(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Fe(this,u(l,{isAutoIncrement:!0}))}default(e){return new Fe(this,u(l,{defaultValue:e}))}},xn=class extends T{constructor(){super(f.U256)}index(e="btree"){return new Ee(this,u(l,{indexType:e}))}unique(){return new Ee(this,u(l,{isUnique:!0}))}primaryKey(){return new Ee(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Ee(this,u(l,{isAutoIncrement:!0}))}default(e){return new Ee(this,u(l,{defaultValue:e}))}},Tn=class extends T{constructor(){super(f.I8)}index(e="btree"){return new Re(this,u(l,{indexType:e}))}unique(){return new Re(this,u(l,{isUnique:!0}))}primaryKey(){return new Re(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Re(this,u(l,{isAutoIncrement:!0}))}default(e){return new Re(this,u(l,{defaultValue:e}))}},Sn=class extends T{constructor(){super(f.I16)}index(e="btree"){return new De(this,u(l,{indexType:e}))}unique(){return new De(this,u(l,{isUnique:!0}))}primaryKey(){return new De(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new De(this,u(l,{isAutoIncrement:!0}))}default(e){return new De(this,u(l,{defaultValue:e}))}},Mn=class extends T{constructor(){super(f.I32)}index(e="btree"){return new Ve(this,u(l,{indexType:e}))}unique(){return new Ve(this,u(l,{isUnique:!0}))}primaryKey(){return new Ve(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Ve(this,u(l,{isAutoIncrement:!0}))}default(e){return new Ve(this,u(l,{defaultValue:e}))}},An=class extends T{constructor(){super(f.I64)}index(e="btree"){return new Ke(this,u(l,{indexType:e}))}unique(){return new Ke(this,u(l,{isUnique:!0}))}primaryKey(){return new Ke(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Ke(this,u(l,{isAutoIncrement:!0}))}default(e){return new Ke(this,u(l,{defaultValue:e}))}},Cn=class extends T{constructor(){super(f.I128)}index(e="btree"){return new Oe(this,u(l,{indexType:e}))}unique(){return new Oe(this,u(l,{isUnique:!0}))}primaryKey(){return new Oe(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Oe(this,u(l,{isAutoIncrement:!0}))}default(e){return new Oe(this,u(l,{defaultValue:e}))}},qn=class extends T{constructor(){super(f.I256)}index(e="btree"){return new Ne(this,u(l,{indexType:e}))}unique(){return new Ne(this,u(l,{isUnique:!0}))}primaryKey(){return new Ne(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Ne(this,u(l,{isAutoIncrement:!0}))}default(e){return new Ne(this,u(l,{defaultValue:e}))}},Pn=class extends T{constructor(){super(f.F32)}default(e){return new jn(this,u(l,{defaultValue:e}))}},Zt=class extends T{constructor(){super(f.F64)}default(e){return new zn(this,u(l,{defaultValue:e}))}},kn=class extends T{constructor(){super(f.Bool)}index(e="btree"){return new bt(this,u(l,{indexType:e}))}unique(){return new bt(this,u(l,{isUnique:!0}))}primaryKey(){return new bt(this,u(l,{isPrimaryKey:!0}))}default(e){return new bt(this,u(l,{defaultValue:e}))}},Fn=class extends T{constructor(){super(f.String)}index(e="btree"){return new wt(this,u(l,{indexType:e}))}unique(){return new wt(this,u(l,{isUnique:!0}))}primaryKey(){return new wt(this,u(l,{isPrimaryKey:!0}))}default(e){return new wt(this,u(l,{defaultValue:e}))}},Dt=class extends T{constructor(t){super(f.Array(t.algebraicType));m(this,"element");this.element=t}default(t){return new Ln(this.element,u(l,{defaultValue:t}))}},En=class extends T{constructor(){super(f.Array(f.U8))}default(e){return new $n(u(l,{defaultValue:e}))}},_t=class extends T{constructor(t){super(wn.getAlgebraicType(t.algebraicType));m(this,"value");this.value=t}default(t){return new Wn(this,u(l,{defaultValue:t}))}},Ae=class extends T{constructor(t,r){function s(a){return Object.keys(a).map(o=>({name:o,get algebraicType(){return a[o].algebraicType}}))}super(f.Product({elements:s(t)}));m(this,"typeName");m(this,"elements");this.typeName=r,this.elements=t}default(t){return new Hn(this,u(l,{defaultValue:t}))}},Nt=class extends T{constructor(){super({tag:"Product",value:{elements:[]}})}},L=class extends T{constructor(t,r){const s=Object.fromEntries(Object.entries(t).map(([o,c])=>[o,c instanceof q?c:new q(c,{})])),a=Object.keys(s).map(o=>({name:o,get algebraicType(){return s[o].typeBuilder.algebraicType}}));super(f.Product({elements:a}));m(this,"row");m(this,"typeName");this.row=s,this.typeName=r}},Ur=class extends T{constructor(t,r){function s(a){return Object.keys(a).map(o=>({name:o,get algebraicType(){return a[o].algebraicType}}))}super(f.Sum({variants:s(t)}));m(this,"variants");m(this,"typeName");this.variants=t,this.typeName=r;for(const a of Object.keys(t)){const o=Object.getOwnPropertyDescriptor(t,a),c=!!o&&(typeof o.get=="function"||typeof o.set=="function");let d=!1;if(c||(d=t[a]instanceof Nt),d){const h=this.create(a);Object.defineProperty(this,a,{value:h,writable:!1,enumerable:!0,configurable:!1})}else Object.defineProperty(this,a,{value:I=>this.create(a,I),writable:!1,enumerable:!0,configurable:!1})}}create(t,r){return r===void 0?{tag:t}:{tag:t,value:r}}default(t){return new Cr(this,u(l,{defaultValue:t}))}},jt=Ur,Rn=class extends Ur{index(e="btree"){return new Gt(this,u(l,{indexType:e}))}primaryKey(){return new Gt(this,u(l,{isPrimaryKey:!0}))}},Dn=class extends T{constructor(){super(Br.getAlgebraicType())}default(e){return new Qn(this,u(l,{defaultValue:e}))}},Vn=class extends T{constructor(){super(_r.getAlgebraicType())}index(e="btree"){return new je(this,u(l,{indexType:e}))}unique(){return new je(this,u(l,{isUnique:!0}))}primaryKey(){return new je(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new je(this,u(l,{isAutoIncrement:!0}))}default(e){return new je(this,u(l,{defaultValue:e}))}},Kn=class extends T{constructor(){super(vt.getAlgebraicType())}index(e="btree"){return new ze(this,u(l,{indexType:e}))}unique(){return new ze(this,u(l,{isUnique:!0}))}primaryKey(){return new ze(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new ze(this,u(l,{isAutoIncrement:!0}))}default(e){return new ze(this,u(l,{defaultValue:e}))}},On=class extends T{constructor(){super(it.getAlgebraicType())}index(e="btree"){return new Le(this,u(l,{indexType:e}))}unique(){return new Le(this,u(l,{isUnique:!0}))}primaryKey(){return new Le(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new Le(this,u(l,{isAutoIncrement:!0}))}default(e){return new Le(this,u(l,{defaultValue:e}))}},Nn=class extends T{constructor(){super(Me.getAlgebraicType())}index(e="btree"){return new $e(this,u(l,{indexType:e}))}unique(){return new $e(this,u(l,{isUnique:!0}))}primaryKey(){return new $e(this,u(l,{isPrimaryKey:!0}))}autoInc(){return new $e(this,u(l,{isAutoIncrement:!0}))}default(e){return new $e(this,u(l,{defaultValue:e}))}},l={},q=class{constructor(e,t){m(this,"typeBuilder");m(this,"columnMetadata");this.typeBuilder=e,this.columnMetadata=t}serialize(e,t){f.serializeValue(e,this.typeBuilder.algebraicType,t)}deserialize(e){return f.deserializeValue(e,this.typeBuilder.algebraicType)}},Ce=class oe extends q{index(t="btree"){return new oe(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new oe(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new oe(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new oe(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new oe(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},qe=class ce extends q{index(t="btree"){return new ce(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new ce(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new ce(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new ce(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new ce(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Pe=class le extends q{index(t="btree"){return new le(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new le(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new le(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new le(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new le(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},ke=class de extends q{index(t="btree"){return new de(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new de(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new de(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new de(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new de(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Fe=class he extends q{index(t="btree"){return new he(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new he(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new he(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new he(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new he(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Ee=class pe extends q{index(t="btree"){return new pe(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new pe(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new pe(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new pe(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new pe(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Re=class me extends q{index(t="btree"){return new me(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new me(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new me(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new me(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new me(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},De=class fe extends q{index(t="btree"){return new fe(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new fe(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new fe(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new fe(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new fe(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Ve=class ye extends q{index(t="btree"){return new ye(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new ye(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new ye(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new ye(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new ye(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Ke=class ge extends q{index(t="btree"){return new ge(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new ge(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new ge(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new ge(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new ge(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Oe=class be extends q{index(t="btree"){return new be(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new be(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new be(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new be(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new be(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Ne=class we extends q{index(t="btree"){return new we(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new we(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new we(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}autoInc(){return new we(this.typeBuilder,u(this.columnMetadata,{isAutoIncrement:!0}))}default(t){return new we(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},jn=class xr extends q{default(t){return new xr(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},zn=class Tr extends q{default(t){return new Tr(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},bt=class Ze extends q{index(t="btree"){return new Ze(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new Ze(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new Ze(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}default(t){return new Ze(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},wt=class Ge extends q{index(t="btree"){return new Ge(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new Ge(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new Ge(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}default(t){return new Ge(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Ln=class Sr extends q{default(t){return new Sr(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},$n=class extends q{constructor(e){super(new T(f.Array(f.U8)),e)}},Wn=class Mr extends q{default(t){return new Mr(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Hn=class Ar extends q{default(t){return new Ar(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Cr=class qr extends q{default(t){return new qr(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Gt=class Vt extends Cr{index(t="btree"){return new Vt(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}primaryKey(){return new Vt(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}},Qn=class Pr extends q{default(t){return new Pr(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},je=class Xe extends q{index(t="btree"){return new Xe(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new Xe(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new Xe(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}default(t){return new Xe(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},ze=class Ye extends q{index(t="btree"){return new Ye(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new Ye(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new Ye(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}default(t){return new Ye(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Le=class Je extends q{index(t="btree"){return new Je(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new Je(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new Je(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}default(t){return new Je(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},$e=class et extends q{index(t="btree"){return new et(this.typeBuilder,u(this.columnMetadata,{indexType:t}))}unique(){return new et(this.typeBuilder,u(this.columnMetadata,{isUnique:!0}))}primaryKey(){return new et(this.typeBuilder,u(this.columnMetadata,{isPrimaryKey:!0}))}default(t){return new et(this.typeBuilder,u(this.columnMetadata,{defaultValue:t}))}},Zn=class extends T{constructor(t){super(f.Ref(t));m(this,"ref");m(this,"__spacetimeType");this.ref=t}},Gn=(e,t)=>{let r=e,s;if(typeof e=="string"){if(!t)throw new TypeError("When providing a name, you must also provide the variants object or array.");r=t,s=e}if(Array.isArray(r)){const a={};for(const o of r)a[o]=new Nt;return new Rn(a,s)}return new jt(r,s)},n={bool:()=>new kn,string:()=>new Fn,number:()=>new Zt,i8:()=>new Tn,u8:()=>new In,i16:()=>new Sn,u16:()=>new vn,i32:()=>new Mn,u32:()=>new _n,i64:()=>new An,u64:()=>new Bn,i128:()=>new Cn,u128:()=>new Un,i256:()=>new qn,u256:()=>new xn,f32:()=>new Pn,f64:()=>new Zt,object:(e,t)=>{if(typeof e=="string"){if(!t)throw new TypeError("When providing a name, you must also provide the object.");return new Ae(t,e)}return new Ae(e,void 0)},row:(e,t)=>{const[r,s]=typeof e=="string"?[t,e]:[e,void 0];return new L(r,s)},array(e){return new Dt(e)},enum:Gn,unit(){return new Nt},lazy(e){let t=null;const r=()=>t??(t=e());return new Proxy({},{get(a,o,c){const d=r(),h=Reflect.get(d,o,c);return typeof h=="function"?h.bind(d):h},set(a,o,c,d){return Reflect.set(r(),o,c,d)},has(a,o){return o in r()},ownKeys(){return Reflect.ownKeys(r())},getOwnPropertyDescriptor(a,o){return Object.getOwnPropertyDescriptor(r(),o)},getPrototypeOf(){return Object.getPrototypeOf(r())}})},scheduleAt:()=>new Dn,option(e){return new _t(e)},identity:()=>new Vn,connectionId:()=>new Kn,timestamp:()=>new On,timeDuration:()=>new Nn,byteArray:()=>new En},Xn=n.enum("RowSizeHint",{FixedSize:n.u16(),RowOffsets:n.array(n.u64())}),Yn=Xn,Kt=n.object("BsatnRowList",{get sizeHint(){return Yn},rowsData:n.byteArray()}),Jn=n.object("CallReducer",{reducer:n.string(),args:n.byteArray(),requestId:n.u32(),flags:n.u8()}),ei=n.object("Subscribe",{queryStrings:n.array(n.string()),requestId:n.u32()}),ti=n.object("OneOffQuery",{messageId:n.byteArray(),queryString:n.string()}),J=n.object("QueryId",{id:n.u32()}),ri=n.object("SubscribeSingle",{query:n.string(),requestId:n.u32(),get queryId(){return J}}),ni=n.object("SubscribeMulti",{queryStrings:n.array(n.string()),requestId:n.u32(),get queryId(){return J}}),ii=n.object("Unsubscribe",{requestId:n.u32(),get queryId(){return J}}),si=n.object("UnsubscribeMulti",{requestId:n.u32(),get queryId(){return J}}),ai=n.object("CallProcedure",{procedure:n.string(),args:n.byteArray(),requestId:n.u32(),flags:n.u8()}),ui=n.enum("ClientMessage",{get CallReducer(){return Jn},get Subscribe(){return ei},get OneOffQuery(){return ti},get SubscribeSingle(){return ri},get SubscribeMulti(){return ni},get Unsubscribe(){return ii},get UnsubscribeMulti(){return si},get CallProcedure(){return ai}}),We=ui,kr=n.object("QueryUpdate",{get deletes(){return Kt},get inserts(){return Kt}}),oi=n.enum("CompressableQueryUpdate",{get Uncompressed(){return kr},Brotli:n.byteArray(),Gzip:n.byteArray()}),ci=oi,Fr=n.object("TableUpdate",{tableId:n.u32(),tableName:n.string(),numRows:n.u64(),get updates(){return n.array(ci)}}),ft=n.object("DatabaseUpdate",{get tables(){return n.array(Fr)}}),li=n.object("InitialSubscription",{get databaseUpdate(){return ft},requestId:n.u32(),totalHostExecutionDuration:n.timeDuration()}),di=n.enum("UpdateStatus",{get Committed(){return ft},Failed:n.string(),OutOfEnergy:n.unit()}),hi=di,pi=n.object("ReducerCallInfo",{reducerName:n.string(),reducerId:n.u32(),args:n.byteArray(),requestId:n.u32()}),mi=n.object("EnergyQuanta",{quanta:n.u128()}),fi=n.object("TransactionUpdate",{get status(){return hi},timestamp:n.timestamp(),callerIdentity:n.identity(),callerConnectionId:n.connectionId(),get reducerCall(){return pi},get energyQuantaUsed(){return mi},totalHostExecutionDuration:n.timeDuration()}),yi=n.object("TransactionUpdateLight",{requestId:n.u32(),get update(){return ft}}),gi=n.object("IdentityToken",{identity:n.identity(),token:n.string(),connectionId:n.connectionId()}),bi=n.object("OneOffTable",{tableName:n.string(),get rows(){return Kt}}),wi=n.object("OneOffQueryResponse",{messageId:n.byteArray(),error:n.option(n.string()),get tables(){return n.array(bi)},totalHostExecutionDuration:n.timeDuration()}),Er=n.object("SubscribeRows",{tableId:n.u32(),tableName:n.string(),get tableRows(){return Fr}}),Ii=n.object("SubscribeApplied",{requestId:n.u32(),totalHostExecutionDurationMicros:n.u64(),get queryId(){return J},get rows(){return Er}}),vi=n.object("UnsubscribeApplied",{requestId:n.u32(),totalHostExecutionDurationMicros:n.u64(),get queryId(){return J},get rows(){return Er}}),_i=n.object("SubscriptionError",{totalHostExecutionDurationMicros:n.u64(),requestId:n.option(n.u32()),queryId:n.option(n.u32()),tableId:n.option(n.u32()),error:n.string()}),Bi=n.object("SubscribeMultiApplied",{requestId:n.u32(),totalHostExecutionDurationMicros:n.u64(),get queryId(){return J},get update(){return ft}}),Ui=n.object("UnsubscribeMultiApplied",{requestId:n.u32(),totalHostExecutionDurationMicros:n.u64(),get queryId(){return J},get update(){return ft}}),xi=n.enum("ProcedureStatus",{Returned:n.byteArray(),OutOfEnergy:n.unit(),InternalError:n.string()}),Ti=xi,Si=n.object("ProcedureResult",{get status(){return Ti},timestamp:n.timestamp(),totalHostExecutionDuration:n.timeDuration(),requestId:n.u32()}),Mi=n.enum("ServerMessage",{get InitialSubscription(){return li},get TransactionUpdate(){return fi},get TransactionUpdateLight(){return yi},get IdentityToken(){return gi},get OneOffQueryResponse(){return wi},get SubscribeApplied(){return Ii},get UnsubscribeApplied(){return vi},get SubscriptionError(){return _i},get SubscribeMultiApplied(){return Bi},get UnsubscribeMultiApplied(){return Ui},get ProcedureResult(){return Si}}),Ai=Mi,ne,lr,qt=(lr=class{constructor(){v(this,ne,new Map)}on(e,t){let r=i(this,ne).get(e);r||(r=new Set,i(this,ne).set(e,r)),r.add(t)}off(e,t){const r=i(this,ne).get(e);r&&r.delete(t)}emit(e,...t){const r=i(this,ne).get(e);if(r)for(const s of r)s(...t)}},ne=new WeakMap,lr),Ci={component:"ðŸ“¦",info:"â„¹ï¸",warn:"âš ï¸",error:"âŒ",debug:"ðŸ›"},qi={component:"color: #fff; background-color: #8D6FDD; padding: 2px 5px; border-radius: 3px;",info:"color: #fff; background-color: #007bff; padding: 2px 5px; border-radius: 3px;",warn:"color: #fff; background-color: #ffc107; padding: 2px 5px; border-radius: 3px;",error:"color: #fff; background-color: #dc3545; padding: 2px 5px; border-radius: 3px;",debug:"color: #fff; background-color: #28a745; padding: 2px 5px; border-radius: 3px;"},Pi={component:"color: #8D6FDD;",info:"color: #007bff;",warn:"color: #ffc107;",error:"color: #dc3545;",debug:"color: #28a745;"},Y=(e,t)=>{console.log(`%c${Ci[e]} ${e.toUpperCase()}%c ${t}`,qi[e],Pi[e])},Xt=(e,t)=>e===t?0:e<t?-1:1,Ut,Rr,dr,ki=(dr=class{constructor(e){v(this,Ut);m(this,"rows");m(this,"tableDef");m(this,"emitter");m(this,"applyOperations",(e,t)=>{const r=[];if(Object.values(this.tableDef.columns).some(a=>a.columnMetadata.isPrimaryKey===!0)){const a=new Map,o=new Map;for(const c of e)if(c.type==="insert"){const[d,h]=a.get(c.rowId)||[c,0];a.set(c.rowId,[c,h+1])}else{const[d,h]=o.get(c.rowId)||[c,0];o.set(c.rowId,[c,h+1])}for(const[c,[d,h]]of a){const I=o.get(c);if(I){const[b,U]=I,M=h-U,A=this.update(t,c,d.row,M);A&&r.push(A),o.delete(c)}else{const b=this.insert(t,d,h);b&&r.push(b)}}for(const[c,d]of o.values()){const h=this.delete(t,c,d);h&&r.push(h)}}else for(const a of e)if(a.type==="insert"){const o=this.insert(t,a);o&&r.push(o)}else{const o=this.delete(t,a);o&&r.push(o)}return r});m(this,"update",(e,t,r,s=0)=>{const a=this.rows.get(t);if(!a){Y("error",`Updating a row that was not present in the cache. Table: ${this.tableDef.name}, RowId: ${t}`);return}const[o,c]=a,d=Math.max(1,c+s);if(c+s<=0){Y("error",`Negative reference count for in table ${this.tableDef.name} row ${t} (${c} + ${s})`);return}return this.rows.set(t,[r,d]),c===0?(Y("error",`Updating a row id in table ${this.tableDef.name} which was not present in the cache (rowId: ${t})`),{type:"insert",table:this.tableDef.name,cb:()=>{this.emitter.emit("insert",e,r)}}):{type:"update",table:this.tableDef.name,cb:()=>{this.emitter.emit("update",e,o,r)}}});m(this,"insert",(e,t,r=1)=>{const[s,a]=this.rows.get(t.rowId)||[t.row,0];if(this.rows.set(t.rowId,[t.row,a+r]),a===0)return{type:"insert",table:this.tableDef.name,cb:()=>{this.emitter.emit("insert",e,t.row)}}});m(this,"delete",(e,t,r=1)=>{const[s,a]=this.rows.get(t.rowId)||[t.row,0];if(a===0){Y("warn","Deleting a row that was not present in the cache");return}if(a<=r)return this.rows.delete(t.rowId),{type:"delete",table:this.tableDef.name,cb:()=>{this.emitter.emit("delete",e,t.row)}};this.rows.set(t.rowId,[t.row,a-r])});m(this,"onInsert",e=>{this.emitter.on("insert",e)});m(this,"onDelete",e=>{this.emitter.on("delete",e)});m(this,"onUpdate",e=>{this.emitter.on("update",e)});m(this,"removeOnInsert",e=>{this.emitter.off("insert",e)});m(this,"removeOnDelete",e=>{this.emitter.off("delete",e)});m(this,"removeOnUpdate",e=>{this.emitter.off("update",e)});this.tableDef=e,this.rows=new Map,this.emitter=new qt;const t=this.tableDef.indexes||{};for(const r of t){const s=r,a=g(this,Ut,Rr).call(this,this.tableDef,s);this[r.name]=a}}count(){return BigInt(this.rows.size)}iter(){function*e(t){for(const[r]of t.values())yield r}return e(this.rows)}[Symbol.iterator](){return this.iter()}},Ut=new WeakSet,Rr=function(e,t){if(t.algorithm!=="btree")throw new Error("Only btree indexes are supported in TableCacheImpl");const r=t.columns,s=d=>r.map(h=>d[h]),a=(d,h)=>{const I=s(d),b=Array.isArray(h)?h:[h],U=Math.max(0,b.length-1);for(let C=0;C<U;C++)if(!Qe(I[C],b[C]))return!1;const M=b[b.length-1],A=I[U];if(M&&typeof M=="object"&&"from"in M&&"to"in M){const C=M.from,R=M.to;if(C.tag!=="unbounded"){const _=Xt(A,C.value);if(_<0||_===0&&C.tag==="excluded")return!1}if(R.tag!=="unbounded"){const _=Xt(A,R.value);if(_>0||_===0&&R.tag==="excluded")return!1}return!0}else return!!Qe(A,M)},o=e.constraints.some(d=>d.constraint!=="unique"?!1:Qe(d.columns,t.columns)),c=this;return o?{find:h=>{const I=Array.isArray(h)?h:[h];for(const b of c.iter())if(Qe(s(b),I))return b;return null}}:{*filter(h){for(const I of c.iter())a(I,h)&&(yield I)}}},dr),Fi=class{constructor(){m(this,"map",new Map)}get(e){return this.map.get(e)}set(e,t){return this.map.set(e,t),this}has(e){return this.map.has(e)}delete(e){return this.map.delete(e)}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}[Symbol.iterator](){return this.entries()}},Ei=class{constructor(){m(this,"tables",new Fi)}getTable(e){const t=this.tables.get(e);if(!t)throw console.error("The table has not been registered for this client. Please register the table before using it. If you have registered global tables using the SpacetimeDBClient.registerTables() or `registerTable()` method, please make sure that is executed first!"),new Error(`Table ${String(e)} does not exist`);return t}getOrCreateTable(e){const t=e.name,r=this.tables.get(t);if(r)return r;const s=new ki(e);return this.tables.set(t,s),s}};function Ri(e,t){const r=Math.min(e.length,t.length);for(let s=0;s<r;s++){const a=e[s],o=t[s];if(a!==o)return typeof a=="number"&&typeof o=="number"?a-o:typeof a=="string"&&typeof o=="string"?a.localeCompare(o):typeof a=="string"?1:-1}return e.length-t.length}var Dr=class Ot{constructor(t,r,s,a=null,o=null){m(this,"major");m(this,"minor");m(this,"patch");m(this,"preRelease");m(this,"buildInfo");this.major=t,this.minor=r,this.patch=s,this.preRelease=a,this.buildInfo=o}toString(){let t=`${this.major}.${this.minor}.${this.patch}`;return this.preRelease&&(t+=`-${this.preRelease.join(".")}`),this.buildInfo&&(t+=`+${this.buildInfo}`),t}compare(t){return this.major!==t.major?this.major-t.major:this.minor!==t.minor?this.minor-t.minor:this.patch!==t.patch?this.patch-t.patch:this.preRelease&&t.preRelease?Ri(this.preRelease,t.preRelease):this.preRelease||t.preRelease?-1:0}clone(){return new Ot(this.major,this.minor,this.patch,this.preRelease?[...this.preRelease]:null,this.buildInfo)}static parseVersionString(t){const r=/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?(?:\+([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?$/,s=t.match(r);if(!s)throw new Error(`Invalid version string: ${t}`);const a=parseInt(s[1],10),o=parseInt(s[2],10),c=parseInt(s[3],10),d=s[4]?s[4].split(".").map(I=>isNaN(Number(I))?I:Number(I)):null,h=s[5]||null;return new Ot(a,o,c,d,h)}},Vr=new Dr(1,4,0);function Di(e){if(e===void 0)throw new Error(Yt(e));if(Dr.parseVersionString(e).compare(Vr)<0)throw new Error(Yt(e))}function Yt(e){return`Module code was generated with an incompatible version of the spacetimedb cli (${e}). Update the cli version to at least ${Vr.toString()} and regenerate the bindings. You can upgrade to the latest cli version by running: spacetime version upgrade`}async function Kr(e,t,r=128*1024){let s=0;const a=new ReadableStream({pull(A){if(s<e.length){const C=e.subarray(s,Math.min(s+r,e.length));A.enqueue(C),s+=r}else A.close()}}),o=new DecompressionStream(t),d=a.pipeThrough(o).getReader(),h=[];let I=0,b;for(;!(b=await d.read()).done;)h.push(b.value),I+=b.value.length;const U=new Uint8Array(I);let M=0;for(const A of h)U.set(A,M),M+=A.length;return U}async function Vi(){if(typeof globalThis.WebSocket<"u")return globalThis.WebSocket;const e=new Function("m","return import(m)");try{const{WebSocket:t}=await e("undici");return t}catch(t){throw console.warn("[spacetimedb-sdk] No global WebSocket found. On Node 18â€“21, please install `undici` (npm install undici) to enable WebSocket support."),t}}var Ie,$,Or,Nr,jr,zr,ve,Ki=(ve=class{constructor(t){v(this,$);m(this,"onclose");m(this,"onopen");m(this,"onmessage");m(this,"onerror");v(this,Ie);this.onmessage=void 0,this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,t.onmessage=g(this,$,Or).bind(this),t.onerror=g(this,$,jr).bind(this),t.onclose=g(this,$,zr).bind(this),t.onopen=g(this,$,Nr).bind(this),t.binaryType="arraybuffer",p(this,Ie,t)}send(t){i(this,Ie).send(t)}close(){i(this,Ie).close()}static async createWebSocketFn({url:t,nameOrAddress:r,wsProtocol:s,authToken:a,compression:o,lightMode:c,confirmedReads:d}){const h=new Headers,I=await Vi();let b;if(a){h.set("Authorization",`Bearer ${a}`);const A=new URL("v1/identity/websocket-token",t);A.protocol=t.protocol==="wss:"?"https:":"http:";const C=await fetch(A,{method:"POST",headers:h});if(C.ok){const{token:R}=await C.json();b=R}else return Promise.reject(new Error(`Failed to verify token: ${C.statusText}`))}const U=new URL(`v1/database/${r}/subscribe`,t);b&&U.searchParams.set("token",b),U.searchParams.set("compression",o==="gzip"?"Gzip":"None"),c&&U.searchParams.set("light","true"),d!==void 0&&U.searchParams.set("confirmed",d.toString());const M=new I(U.toString(),s);return new ve(M)}},Ie=new WeakMap,$=new WeakSet,Or=async function(t){var a;const r=new Uint8Array(t.data);let s;if(r[0]===0)s=r.slice(1);else{if(r[0]===1)throw new Error("Brotli Compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");if(r[0]===2)s=await Kr(r.slice(1),"gzip");else throw new Error("Unexpected Compression Algorithm. Please use `gzip` or `none`")}(a=this.onmessage)==null||a.call(this,{data:s})},Nr=function(t){var r;(r=this.onopen)==null||r.call(this,t)},jr=function(t){var r;(r=this.onerror)==null||r.call(this,t)},zr=function(t){var r;(r=this.onclose)==null||r.call(this,t)},ve),_e,Be,xt,at,ie,ut,ot,ct,Ue,hr,Oi=(hr=class{constructor(t,r){v(this,_e);v(this,Be);v(this,xt);v(this,at);v(this,ie,new qt);v(this,ut,"gzip");v(this,ot,!1);v(this,ct);v(this,Ue);this.remoteModule=t,this.dbConnectionCtor=r,p(this,Ue,Ki.createWebSocketFn)}withUri(t){return p(this,_e,new URL(t)),this}withModuleName(t){return p(this,Be,t),this}withToken(t){return p(this,at,t),this}withWSFn(t){return p(this,Ue,t),this}withCompression(t){return p(this,ut,t),this}withLightMode(t){return p(this,ot,t),this}withConfirmedReads(t){return p(this,ct,t),this}onConnect(t){return i(this,ie).on("connect",t),this}onConnectError(t){return i(this,ie).on("connectError",t),this}onDisconnect(t){return i(this,ie).on("disconnect",t),this}build(){var t;if(!i(this,_e))throw new Error("URI is required to connect to SpacetimeDB");if(!i(this,Be))throw new Error("Database name or address is required to connect to SpacetimeDB");return Di((t=this.remoteModule.versionInfo)==null?void 0:t.cliVersion),this.dbConnectionCtor({uri:i(this,_e),nameOrAddress:i(this,Be),identity:i(this,xt),token:i(this,at),emitter:i(this,ie),compression:i(this,ut),lightMode:i(this,ot),confirmedReads:i(this,ct),createWSFn:i(this,Ue),remoteModule:this.remoteModule})}},_e=new WeakMap,Be=new WeakMap,xt=new WeakMap,at=new WeakMap,ie=new WeakMap,ut=new WeakMap,ot=new WeakMap,ct=new WeakMap,Ue=new WeakMap,hr),lt,dt,pr,Lr=(pr=class{constructor(e){v(this,lt);v(this,dt);this.db=e}onApplied(e){return p(this,lt,e),this}onError(e){return p(this,dt,e),this}subscribe(e){const t=Array.isArray(e)?e:[e];if(t.length===0)throw new Error("Subscriptions must have at least one query");return new ji(this.db,t,i(this,lt),i(this,dt))}subscribeToAllTables(){this.subscribe("SELECT * FROM *")}},lt=new WeakMap,dt=new WeakMap,pr),Ni=class{constructor(){m(this,"subscriptions",new Map)}},xe,se,Z,G,X,mr,ji=(mr=class{constructor(e,t,r,s){v(this,xe);v(this,se,!1);v(this,Z,!1);v(this,G,!1);v(this,X,new qt);this.db=e,i(this,X).on("applied",a=>{p(this,G,!0),r&&r(a)}),i(this,X).on("error",(a,o)=>{p(this,G,!1),p(this,Z,!0),s&&s(a,o)}),p(this,xe,this.db.registerSubscription(this,i(this,X),t))}unsubscribe(){if(i(this,se))throw new Error("Unsubscribe has already been called");p(this,se,!0),this.db.unregisterSubscription(i(this,xe)),i(this,X).on("end",e=>{p(this,Z,!0),p(this,G,!1)})}unsubscribeThen(e){if(i(this,Z))throw new Error("Subscription has already ended");if(i(this,se))throw new Error("Unsubscribe has already been called");p(this,se,!0),this.db.unregisterSubscription(i(this,xe)),i(this,X).on("end",t=>{p(this,Z,!0),p(this,G,!1),e(t)})}isEnded(){return i(this,Z)}isActive(){return i(this,G)}},xe=new WeakMap,se=new WeakMap,Z=new WeakMap,G=new WeakMap,X=new WeakMap,mr);function zi(e){switch(e){case"FullUpdate":return 0;case"NoSuccessNotify":return 1}}var ht,Tt,E,Te,St,pt,j,ae,mt,Se,Mt,At,B,$r,Wr,Hr,Qr,Q,Zr,tt,Gr,ee,Xr,Yr,fr,Li=(fr=class{constructor({uri:e,nameOrAddress:t,identity:r,token:s,emitter:a,remoteModule:o,createWSFn:c,compression:d,lightMode:h,confirmedReads:I}){v(this,B);m(this,"isActive",!1);m(this,"identity");m(this,"token");m(this,"db");m(this,"reducers");m(this,"setReducerFlags");m(this,"procedures");m(this,"connectionId",vt.random());v(this,ht,0);v(this,Tt,0);v(this,E);v(this,Te,new qt);v(this,St);v(this,pt,Promise.resolve());v(this,j,new Ni);v(this,ae);v(this,mt,new Map);v(this,Se,new Map);m(this,"clientCache");m(this,"ws");m(this,"wsPromise");v(this,Mt,()=>{const e=i(this,ht);return p(this,ht,i(this,ht)+1),e});v(this,At,()=>Wt(this,Tt)._++);m(this,"subscriptionBuilder",()=>new Lr(this));Y("info","Connecting to SpacetimeDB WS...");const b=new URL(e.toString());/^wss?:/.test(e.protocol)||(b.protocol=b.protocol==="https:"?"wss:":"ws:"),this.identity=r,this.token=s,p(this,ae,o),p(this,E,a);const U=this.connectionId.toHexString();b.searchParams.set("connection_id",U),this.clientCache=new Ei,this.db=g(this,B,$r).call(this,o),this.reducers=g(this,B,Wr).call(this,o),this.setReducerFlags=g(this,B,Hr).call(this,o),this.procedures=g(this,B,Qr).call(this,o),this.wsPromise=c({url:b,nameOrAddress:t,wsProtocol:"v1.bsatn.spacetimedb",authToken:s,compression:d,lightMode:h,confirmedReads:I}).then(M=>(this.ws=M,this.ws.onclose=()=>{i(this,E).emit("disconnect",this),this.isActive=!1},this.ws.onerror=A=>{i(this,E).emit("connectError",this,A),this.isActive=!1},this.ws.onopen=g(this,B,Gr).bind(this),this.ws.onmessage=g(this,B,Yr).bind(this),M)).catch(M=>{Y("error","Error connecting to SpacetimeDB WS"),i(this,E).emit("connectError",this,M)})}registerSubscription(e,t,r){const s=i(this,Mt).call(this);return i(this,j).subscriptions.set(s,{handle:e,emitter:t}),g(this,B,tt).call(this,We.SubscribeMulti({queryStrings:r,queryId:{id:s},requestId:0})),s}unregisterSubscription(e){g(this,B,tt).call(this,We.UnsubscribeMulti({queryId:{id:e},requestId:0}))}callReducer(e,t,r){const s=We.CallReducer({reducer:e,args:t,requestId:0,flags:zi(r)});g(this,B,tt).call(this,s)}callReducerWithParams(e,t,r,s){const a=new ue(1024);re.serializeValue(a,t,r);const o=a.getBuffer();this.callReducer(e,o,s)}callProcedure(e,t){const{promise:r,resolve:s,reject:a}=Promise.withResolvers(),o=i(this,At).call(this),c=We.CallProcedure({procedure:e,args:t,requestId:o,flags:0});return g(this,B,tt).call(this,c),i(this,Se).set(o,d=>{d.tag==="Ok"?s(d.value):a(d.value)}),r}callProcedureWithParams(e,t,r,s){const a=new ue(1024);re.serializeValue(a,t,r);const o=a.getBuffer();return this.callProcedure(e,o).then(c=>f.deserializeValue(new te(c),s))}disconnect(){this.wsPromise.then(e=>{e&&e.close()})}on(e,t){i(this,E).on(e,t)}off(e,t){i(this,E).off(e,t)}onConnect(e){i(this,E).on("connect",e)}onDisconnect(e){i(this,E).on("disconnect",e)}onConnectError(e){i(this,E).on("connectError",e)}removeOnConnect(e){i(this,E).off("connect",e)}removeOnDisconnect(e){i(this,E).off("disconnect",e)}removeOnConnectError(e){i(this,E).off("connectError",e)}onReducer(e,t){i(this,Te).on(e,t)}offReducer(e,t){i(this,Te).off(e,t)}},ht=new WeakMap,Tt=new WeakMap,E=new WeakMap,Te=new WeakMap,St=new WeakMap,pt=new WeakMap,j=new WeakMap,ae=new WeakMap,mt=new WeakMap,Se=new WeakMap,Mt=new WeakMap,At=new WeakMap,B=new WeakSet,$r=function(e){const t=Object.create(null);for(const r of e.tables){const s=r.accessorName;Object.defineProperty(t,s,{enumerable:!0,configurable:!1,get:()=>this.clientCache.getOrCreateTable(r)})}return t},Wr=function(e){const t={};for(const r of e.reducers){const s=rt(r.name);t[s]=c=>{const d=i(this,mt).get(r.name)??"FullUpdate";this.callReducerWithParams(r.name,r.paramsType,c,d)};const a=`on${st(r.name)}`;t[a]=c=>{this.onReducer(r.name,c)};const o=`removeOn${st(r.name)}`;t[o]=c=>{this.offReducer(r.name,c)}}return t},Hr=function(e){const t=Object.create(null);for(const r of e.reducers){const s=rt(r.name);Object.defineProperty(t,s,{enumerable:!0,configurable:!1,value:a=>{i(this,mt).set(r.name,a)}})}return t},Qr=function(e){const t={};for(const r of e.procedures){const s=rt(r.name),a=new Ae(r.params).algebraicType.value,o=r.returnType.algebraicType;t[s]=c=>this.callProcedureWithParams(r.name,a,c,o)}return t},Q=function(e){return{db:this.db,reducers:this.reducers,setReducerFlags:this.setReducerFlags,isActive:this.isActive,subscriptionBuilder:this.subscriptionBuilder.bind(this),disconnect:this.disconnect.bind(this),event:e}},Zr=async function(e){const t=(a,o,c)=>{const d=c.rowsData,h=new te(d),I=[],b=i(this,ae).tables.find(R=>R.name===o),U=b.rowType,A=Object.entries(b.columns).find(R=>R[1].columnMetadata.isPrimaryKey);let C=0;for(;h.remaining>0;){const R=re.deserializeValue(h,U);let _;if(A!==void 0){const F=A[0],D=A[1].typeBuilder.algebraicType;_=f.intoMapKey(D,R[F])}else{const F=d.subarray(C,h.offset);_=yr(F)}C=h.offset,I.push({type:a,rowId:_,row:R})}return I},r=async a=>{const o=a.tableName;let c=[];for(const d of a.updates){let h;if(d.tag==="Gzip"){const I=await Kr(d.value,"gzip");h=f.deserializeValue(new te(I),kr.algebraicType)}else{if(d.tag==="Brotli")throw new Error("Brotli compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");h=d.value}c=c.concat(t("insert",o,h.inserts)),c=c.concat(t("delete",o,h.deletes))}return{tableName:o,operations:c}},s=async a=>{const o=[];for(const c of a.tables)o.push(await r(c));return o};switch(e.tag){case"InitialSubscription":{const a=e.value.databaseUpdate;return{tag:"InitialSubscription",tableUpdates:await s(a)}}case"TransactionUpdateLight":{const a=e.value.update;return{tag:"TransactionUpdateLight",tableUpdates:await s(a)}}case"TransactionUpdate":{const a=e.value,o=a.callerIdentity,c=vt.nullIfZero(a.callerConnectionId),d=a.reducerCall.reducerName,h=a.reducerCall.args,I=a.energyQuantaUsed;let b=[],U="";switch(a.status.tag){case"Committed":b=await s(a.status.value);break;case"Failed":b=[],U=a.status.value;break;case"OutOfEnergy":b=[];break}if(d==="<none>"){console.error(`Received an error from the database: ${U}`);return}let M;return d!==""&&(M={reducerName:d,args:h}),{tag:"TransactionUpdate",tableUpdates:b,identity:o,connectionId:c,reducerInfo:M,status:a.status,energyConsumed:I.quanta,message:U,timestamp:a.timestamp}}case"IdentityToken":return{tag:"IdentityToken",identity:e.value.identity,token:e.value.token,connectionId:e.value.connectionId};case"OneOffQueryResponse":throw new Error(`TypeScript SDK never sends one-off queries, but got OneOffQueryResponse ${e}`);case"SubscribeMultiApplied":{const a=await s(e.value.update);return{tag:"SubscribeApplied",queryId:e.value.queryId.id,tableUpdates:a}}case"UnsubscribeMultiApplied":{const a=await s(e.value.update);return{tag:"UnsubscribeApplied",queryId:e.value.queryId.id,tableUpdates:a}}case"SubscriptionError":return{tag:"SubscriptionError",queryId:e.value.queryId,error:e.value.error};case"ProcedureResult":{const{status:a,requestId:o}=e.value;return{tag:"ProcedureResult",requestId:o,result:a.tag==="Returned"?{tag:"Ok",value:a.value}:a.tag==="OutOfEnergy"?{tag:"Err",value:"Procedure execution aborted due to insufficient energy"}:{tag:"Err",value:a.value}}}}},tt=function(e){this.wsPromise.then(t=>{if(t){const r=new ue(1024);f.serializeValue(r,We.algebraicType,e);const s=r.getBuffer();t.send(s)}})},Gr=function(){this.isActive=!0},ee=function(e,t){const r=[];for(const s of e){const a=s.tableName,o=i(this,ae).tables.find(h=>h.name===a),d=this.clientCache.getOrCreateTable(o).applyOperations(s.operations,t);for(const h of d)r.push(h)}return r},Xr=async function(e){var s,a;const t=f.deserializeValue(new te(e),Ai.algebraicType),r=await g(this,B,Zr).call(this,t);if(r)switch(r.tag){case"InitialSubscription":{const o={tag:"SubscribeApplied"},c=g(this,B,Q).call(this,o),{event:d,...h}=c,I=g(this,B,ee).call(this,r.tableUpdates,c);i(this,E)&&((s=i(this,St))==null||s.call(this,h));for(const b of I)b.cb();break}case"TransactionUpdateLight":{const o={tag:"UnknownTransaction"},c=g(this,B,Q).call(this,o),d=g(this,B,ee).call(this,r.tableUpdates,c);for(const h of d)h.cb();break}case"TransactionUpdate":{let o=r.reducerInfo,c=!1,d;const h=i(this,ae).reducers.find(C=>C.name===o.reducerName);if(!o)c=!0;else try{const C=new te(o.args);d=re.deserializeValue(C,h==null?void 0:h.paramsType)}catch{console.debug("Failed to deserialize reducer arguments"),c=!0}if(c){const C={tag:"UnknownTransaction"},R=g(this,B,Q).call(this,C),_=g(this,B,ee).call(this,r.tableUpdates,R);for(const F of _)F.cb();return}o=o,d=d;const I={callerIdentity:r.identity,status:r.status,callerConnectionId:r.connectionId,timestamp:r.timestamp,energyConsumed:r.energyConsumed,reducer:{name:o.reducerName,args:d}},b={tag:"Reducer",value:I},U=g(this,B,Q).call(this,b),M={...U,event:I},A=g(this,B,ee).call(this,r.tableUpdates,U);i(this,Te).emit(o.reducerName,M,d);for(const C of A)C.cb();break}case"IdentityToken":{this.identity=r.identity,!this.token&&r.token&&(this.token=r.token),this.connectionId=r.connectionId,i(this,E).emit("connect",this,this.identity,this.token);break}case"SubscribeApplied":{const o=i(this,j).subscriptions.get(r.queryId);if(o===void 0){Y("error",`Received SubscribeApplied for unknown queryId ${r.queryId}.`);break}const c={tag:"SubscribeApplied"},d=g(this,B,Q).call(this,c),{event:h,...I}=d,b=g(this,B,ee).call(this,r.tableUpdates,d);o==null||o.emitter.emit("applied",I);for(const U of b)U.cb();break}case"UnsubscribeApplied":{const o=i(this,j).subscriptions.get(r.queryId);if(o===void 0){Y("error",`Received UnsubscribeApplied for unknown queryId ${r.queryId}.`);break}const c={tag:"UnsubscribeApplied"},d=g(this,B,Q).call(this,c),{event:h,...I}=d,b=g(this,B,ee).call(this,r.tableUpdates,d);o==null||o.emitter.emit("end",I),i(this,j).subscriptions.delete(r.queryId);for(const U of b)U.cb();break}case"SubscriptionError":{const o=Error(r.error),c={tag:"Error",value:o},h={...g(this,B,Q).call(this,c),event:o};r.queryId!==void 0?((a=i(this,j).subscriptions.get(r.queryId))==null||a.emitter.emit("error",h,o),i(this,j).subscriptions.delete(r.queryId)):(console.error("Received an error message without a queryId: ",o),i(this,j).subscriptions.forEach(({emitter:I})=>{I.emit("error",h,o)}));break}case"ProcedureResult":{const{requestId:o,result:c}=r,d=i(this,Se).get(o);i(this,Se).delete(o),d==null||d(c);break}}},Yr=function(e){p(this,pt,i(this,pt).then(()=>g(this,B,Xr).call(this,e.data)))},fr),$i=n.enum("Lifecycle",{Init:n.unit(),OnConnect:n.unit(),OnDisconnect:n.unit()}),zt=$i;function Pt(e,t,r,s){if(Jt.has(e))throw new TypeError(`There is already a reducer with the name '${e}'`);Jt.add(e),t instanceof L||(t=new L(t)),t.typeName===void 0&&(t.typeName=st(e));const a=N(t),o=Jr(K.typespace,a).value;K.reducers.push({name:e,params:o,lifecycle:s})}var Jt=new Set;function er(e,t,r){Pt(e,t)}function Wi(e,t,r){Pt(e,t,r,zt.Init)}function Hi(e,t,r){Pt(e,t,r,zt.OnConnect)}function Qi(e,t,r){Pt(e,t,r,zt.OnDisconnect)}var Zi=class{constructor(e){m(this,"reducersType");this.reducersType=Gi(e)}};function Gi(e){return{reducers:e.map(s=>{const a=s.params.row;return{name:s.reducerName,accessorName:s.accessorName,params:a,paramsType:s.paramsSpacetimeType}})}}function Xi(...e){const t=e.length===1&&Array.isArray(e[0])?e[0]:e;return new Zi(t)}function He(e,t){const r={elements:Object.entries(t).map(([s,a])=>({name:s,algebraicType:"typeBuilder"in a?a.typeBuilder.algebraicType:a.algebraicType}))};return{reducerName:e,accessorName:rt(e),params:new L(t),paramsSpacetimeType:r,reducerDef:{name:e,params:r,lifecycle:void 0}}}function tr(e,t,r,s,a){const o=new L(r,st(e.name));let c=N(s).algebraicType;const{value:d}=Jr(K.typespace,N(o));if(K.miscExports.push({tag:"View",value:{name:e.name,index:(t?nr:rr).length,isPublic:e.public,isAnonymous:t,params:d,returnType:c}}),c.tag=="Sum"){const h=a;a=(I,b)=>{const U=h(I,b);return U==null?[]:[U]},c=f.Array(c.value.variants[0].algebraicType)}(t?nr:rr).push({fn:a,params:d,returnType:c,returnTypeBaseSize:nt(K.typespace,c)})}var rr=[],nr=[],Yi=n.enum("RawIndexAlgorithm",{BTree:n.array(n.u16()),Hash:n.array(n.u16()),Direct:n.u16()}),ir=Yi;function sr(e,t,r,s){const a={elements:Object.entries(t).map(([c,d])=>({name:c,algebraicType:N("typeBuilder"in d?d.typeBuilder:d).algebraicType}))},o=N(r).algebraicType;K.miscExports.push({tag:"Procedure",value:{name:e,params:a,returnType:o}}),Ji.push({fn:s,paramsType:a,returnType:o,returnTypeBaseSize:nt(K.typespace,o)})}var Ji=[];function es(...e){return{procedures:e.length===1&&Array.isArray(e[0])?e[0]:e}}function ts(e){return{tables:e.map(r=>{const s=[];return r.rowType.algebraicType.value.elements.forEach(a=>{s.push(a.name)}),{name:r.tableName,accessorName:rt(r.tableName),columns:r.rowType.row,rowType:r.rowSpacetimeType,constraints:[...r.tableDef.constraints.map(a=>({name:a.name,constraint:"unique",columns:Array.from(a.data.value.columns.map(o=>s[o]))}))],indexes:[...r.idxs.map(a=>({name:a.accessorName,unique:r.tableDef.constraints.map(o=>{if(a.algorithm.tag=="BTree")return o.data.value.columns.every(c=>{const d=a.algorithm.value;return Array.isArray(d)?d.includes(c):c===d})}).includes(!0),algorithm:a.algorithm.tag.toLowerCase(),columns:(a.algorithm.tag==="Direct"?[a.algorithm.value]:a.algorithm.value).map(c=>s[c])}))]}})}}var K={typespace:{types:[]},tables:[],reducers:[],types:[],miscExports:[],rowLevelSecurity:[]},ar=new Map;function Jr(e,t){let r=t.algebraicType;for(;r.tag==="Ref";)r=e.types[r.value];return r}function N(e){return e instanceof Ae&&!ns(e)||e instanceof jt||e instanceof L?rs(e):e instanceof _t?new _t(N(e.value)):e instanceof Dt?new Dt(N(e.element)):e}function rs(e){const t=e.algebraicType,r=e.typeName;if(r===void 0)throw new Error(`Missing type name for ${e.constructor.name??"TypeBuilder"} ${JSON.stringify(e)}`);let s=ar.get(t);if(s!=null)return s;const a=e instanceof L||e instanceof Ae?{tag:"Product",value:{elements:[]}}:{tag:"Sum",value:{variants:[]}};if(s=new Zn(K.typespace.types.length),K.typespace.types.push(a),ar.set(t,s),e instanceof L)for(const[o,c]of Object.entries(e.row))a.value.elements.push({name:o,algebraicType:N(c.typeBuilder).algebraicType});else if(e instanceof Ae)for(const[o,c]of Object.entries(e.elements))a.value.elements.push({name:o,algebraicType:N(c).algebraicType});else if(e instanceof jt)for(const[o,c]of Object.entries(e.variants))a.value.variants.push({name:o,algebraicType:N(c).algebraicType});return K.types.push({name:is(r),ty:s.ref,customOrdering:!0}),s}function ns(e){return e.typeName==null&&e.algebraicType.value.elements.length===0}function is(e){const t=e.split(".");return{name:t.pop(),scope:t}}var ss=class{constructor(e,t,r){m(this,"tablesDef");m(this,"typespace");m(this,"schemaType");m(this,"clientVisibilityFilter",{sql(e){K.rowLevelSecurity.push({sql:e})}});this.tablesDef={tables:e},this.typespace=t,this.schemaType=ts(r)}reducer(e,t,r){return typeof t=="function"?(er(e,{}),t):(er(e,t),r)}init(e,t){const[r,s]=typeof e=="string"?[e,t]:["init",e];Wi(r,{},s)}clientConnected(e,t){const[r,s]=typeof e=="string"?[e,t]:["on_connect",e];Hi(r,{},s)}clientDisconnected(e,t){const[r,s]=typeof e=="string"?[e,t]:["on_disconnect",e];Qi(r,{},s)}view(e,t,r){tr(e,!1,{},t,r)}anonymousView(e,t,r){tr(e,!0,{},t,r)}procedure(e,t,r,s){return typeof r=="function"?(sr(e,{},t,r),r):(sr(e,t,r,s),s)}};function as(...e){const t=e.length===1&&Array.isArray(e[0])?e[0]:e,r=t.map(s=>s.tableDef);return K.tables.push(...r),t.map(s=>({name:s.tableName,accessorName:s.tableName,columns:s.rowType.row,rowType:s.rowSpacetimeType,indexes:s.idxs,constraints:s.constraints})),new ss(r,K.typespace,t)}function en(e){return Object.fromEntries(e.map(t=>[t.accessorName,t]))}function W(e,t){const{name:r,public:s=!1,indexes:a=[],scheduled:o}=e,c=new Map,d=[];t instanceof L||(t=new L(t)),t.typeName===void 0&&(t.typeName=st(r));const h=N(t);t.algebraicType.value.elements.forEach((_,F)=>{c.set(_.name,F),d.push(_.name)});const I=[],b=[],U=[],M=[];let A;for(const[_,F]of Object.entries(t.row)){const D=F.columnMetadata;D.isPrimaryKey&&I.push(c.get(_));const yt=D.isUnique||D.isPrimaryKey;if(D.indexType||yt){const kt=D.indexType??"btree",Lt=c.get(_);let Ft;switch(kt){case"btree":Ft=ir.BTree([Lt]);break;case"direct":Ft=ir.Direct(Lt);break}b.push({name:void 0,accessorName:_,algorithm:Ft})}if(yt&&U.push({name:void 0,data:{tag:"Unique",value:{columns:[c.get(_)]}}}),D.isAutoIncrement&&M.push({name:void 0,start:void 0,minValue:void 0,maxValue:void 0,column:c.get(_),increment:1n}),o){const kt=F.typeBuilder.algebraicType;Br.isScheduleAt(kt)&&(A=c.get(_))}}for(const _ of a??[]){let F;switch(_.algorithm){case"btree":F={tag:"BTree",value:_.columns.map(D=>c.get(D))};break;case"direct":F={tag:"Direct",value:c.get(_.column)};break}b.push({name:void 0,accessorName:_.name,algorithm:F})}for(const _ of e.constraints??[])if(_.constraint==="unique"){const F={tag:"Unique",value:{columns:_.columns.map(D=>c.get(D))}};U.push({name:_.name,data:F});continue}for(const _ of b){const D=(_.algorithm.tag==="Direct"?[_.algorithm.value]:_.algorithm.value).map(yt=>d[yt]).join("_");_.name=`${r}_${D}_idx_${_.algorithm.tag.toLowerCase()}`}const C={name:r,productTypeRef:h.ref,primaryKey:I,indexes:b,constraints:U,sequences:M,schedule:o&&A!==void 0?{name:void 0,reducerName:o,scheduledAtColumn:A}:void 0,tableType:{tag:"User"},tableAccess:{tag:s?"Public":"Private"}},R={elements:t.algebraicType.value.elements.map(_=>({name:_.name,algebraicType:_.algebraicType}))};return{rowType:t,tableName:r,rowSpacetimeType:R,tableDef:C,idxs:b,constraints:U}}const us={message:n.string()},os={text:n.string()},cs={name:n.string()},ls={x:n.f32(),y:n.f32(),leftButtonDown:n.bool(),rightButtonDown:n.bool(),middleButtonDown:n.bool(),scrollX:n.f32(),scrollY:n.f32(),isDragging:n.bool(),hoveredElement:n.string(),viewportWidth:n.f32(),viewportHeight:n.f32()},ds={newStatus:n.string()},hs=n.row({identity:n.identity().primaryKey()}),ps=n.row({id:n.u32().primaryKey(),message:n.string(),lastUpdated:n.timestamp()}),ms=n.row({sender:n.identity(),sent:n.timestamp(),text:n.string()}),fs=n.row({identity:n.identity().primaryKey(),x:n.f32(),y:n.f32(),leftButtonDown:n.bool(),rightButtonDown:n.bool(),middleButtonDown:n.bool(),scrollX:n.f32(),scrollY:n.f32(),isDragging:n.bool(),hoveredElement:n.string(),viewportWidth:n.f32(),viewportHeight:n.f32(),lastUpdated:n.timestamp()}),ys=n.row({pollId:n.u64().primaryKey(),question:n.string(),createdBy:n.identity(),createdAt:n.timestamp(),expiresAt:n.option(n.timestamp()),active:n.bool()}),gs=n.row({optionId:n.u64().primaryKey(),pollId:n.u64(),text:n.string()}),bs=n.row({voteId:n.u64().primaryKey(),pollId:n.u64(),optionId:n.u64(),voter:n.identity(),votedAt:n.timestamp()}),ws=n.row({updateId:n.u64().primaryKey(),message:n.string(),timestamp:n.timestamp()}),Is=n.row({identity:n.identity().primaryKey(),name:n.option(n.string()),online:n.bool()});n.object("Admin",{identity:n.identity()});n.object("CurrentStatus",{id:n.u32(),message:n.string(),lastUpdated:n.timestamp()});n.object("Message",{sender:n.identity(),sent:n.timestamp(),text:n.string()});n.object("MouseState",{identity:n.identity(),x:n.f32(),y:n.f32(),leftButtonDown:n.bool(),rightButtonDown:n.bool(),middleButtonDown:n.bool(),scrollX:n.f32(),scrollY:n.f32(),isDragging:n.bool(),hoveredElement:n.string(),viewportWidth:n.f32(),viewportHeight:n.f32(),lastUpdated:n.timestamp()});n.object("Poll",{pollId:n.u64(),question:n.string(),createdBy:n.identity(),createdAt:n.timestamp(),expiresAt:n.option(n.timestamp()),active:n.bool()});n.object("PollOption",{optionId:n.u64(),pollId:n.u64(),text:n.string()});n.object("PollVote",{voteId:n.u64(),pollId:n.u64(),optionId:n.u64(),voter:n.identity(),votedAt:n.timestamp()});n.object("UpdateLog",{updateId:n.u64(),message:n.string(),timestamp:n.timestamp()});n.object("User",{identity:n.identity(),name:n.option(n.string()),online:n.bool()});const tn=as(W({name:"admin",indexes:[{name:"identity",algorithm:"btree",columns:["identity"]}],constraints:[{name:"admin_identity_key",constraint:"unique",columns:["identity"]}]},hs),W({name:"current_status",indexes:[{name:"id",algorithm:"btree",columns:["id"]}],constraints:[{name:"current_status_id_key",constraint:"unique",columns:["id"]}]},ps),W({name:"message",indexes:[],constraints:[]},ms),W({name:"mouse_state",indexes:[{name:"identity",algorithm:"btree",columns:["identity"]}],constraints:[{name:"mouse_state_identity_key",constraint:"unique",columns:["identity"]}]},fs),W({name:"poll",indexes:[{name:"poll_id",algorithm:"btree",columns:["pollId"]}],constraints:[{name:"poll_poll_id_key",constraint:"unique",columns:["pollId"]}]},ys),W({name:"poll_option",indexes:[{name:"option_id",algorithm:"btree",columns:["optionId"]}],constraints:[{name:"poll_option_option_id_key",constraint:"unique",columns:["optionId"]}]},gs),W({name:"poll_vote",indexes:[{name:"vote_id",algorithm:"btree",columns:["voteId"]}],constraints:[{name:"poll_vote_vote_id_key",constraint:"unique",columns:["voteId"]}]},bs),W({name:"update_log",indexes:[{name:"update_id",algorithm:"btree",columns:["updateId"]}],constraints:[{name:"update_log_update_id_key",constraint:"unique",columns:["updateId"]}]},ws),W({name:"user",indexes:[{name:"identity",algorithm:"btree",columns:["identity"]}],constraints:[{name:"user_identity_key",constraint:"unique",columns:["identity"]}]},Is)),rn=Xi(He("add_update",us),He("send_message",os),He("set_name",cs),He("update_mouse_state",ls),He("update_status",ds)),vs=es(),_s={versionInfo:{cliVersion:"1.11.0"},tables:tn.schemaType.tables,reducers:rn.reducersType.reducers,...vs};en(tn.schemaType.tables);en(rn.reducersType.reducers);class Bs extends Lr{}class Us extends Oi{}const Ct=class Ct extends Li{constructor(){super(...arguments),this.subscriptionBuilder=()=>new Bs(this)}};Ct.builder=()=>new Us(_s,t=>new Ct(t));let ur=Ct;export{us as AddUpdate,hs as AdminRow,ps as CurrentStatusRow,ur as DbConnection,Us as DbConnectionBuilder,ms as MessageRow,fs as MouseStateRow,gs as PollOptionRow,ys as PollRow,bs as PollVoteRow,os as SendMessage,cs as SetName,Bs as SubscriptionBuilder,ws as UpdateLogRow,ls as UpdateMouseState,ds as UpdateStatus,Is as UserRow};
